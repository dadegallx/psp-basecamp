# Superset Production Setup
# Uses official Apache Superset image with Caddy for SSL + widget injection
#
# Prerequisites:
#   1. Copy docker/.env.example to docker/.env and configure
#   2. Ensure DNS points to this server
#   3. docker compose -f docker-compose.prod.yml up -d
#
# Architecture:
#   - Caddy handles SSL (auto Let's Encrypt) + widget injection
#   - Superset connects to DO Managed PostgreSQL (external)
#   - Redis runs locally for caching/celery

x-superset-image: &superset-image superset-psp:${SUPERSET_VERSION:-latest}
x-superset-env: &superset-env
  env_file:
    - ./docker/.env

services:
  # ==========================================================================
  # Custom Superset Image Build (adds psycopg2 for PostgreSQL)
  # ==========================================================================
  # ==========================================================================
  # Caddy - Auto SSL + widget injection
  # ==========================================================================
  caddy:
    build: ./caddy
    container_name: superset_caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile.prod:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    env_file:
      - ./docker/.env
    depends_on:
      superset:
        condition: service_healthy

  # ==========================================================================
  # Redis - Local cache and Celery broker
  # ==========================================================================
  redis:
    image: redis:7
    container_name: superset_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Superset Init - Database migrations (runs once)
  # ==========================================================================
  superset-init:
    build:
      context: ./docker
      dockerfile: Dockerfile
    image: *superset-image
    container_name: superset_init
    <<: *superset-env
    command: ["/app/docker/docker-init.sh"]
    user: root
    volumes:
      - ./docker/pythonpath:/app/pythonpath
      - superset_home:/app/superset_home
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      disable: true

  # ==========================================================================
  # Superset App - Main web application (gunicorn)
  # ==========================================================================
  superset:
    image: *superset-image
    container_name: superset_app
    <<: *superset-env
    command: ["/app/docker/docker-bootstrap.sh", "app-gunicorn"]
    user: root
    restart: unless-stopped
    expose:
      - "8088"
    volumes:
      - ./docker/pythonpath:/app/pythonpath
      - superset_home:/app/superset_home
    depends_on:
      superset-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================================================
  # Superset Worker - Celery background tasks
  # ==========================================================================
  superset-worker:
    image: *superset-image
    container_name: superset_worker
    <<: *superset-env
    command: ["/app/docker/docker-bootstrap.sh", "worker"]
    user: root
    restart: unless-stopped
    volumes:
      - ./docker/pythonpath:/app/pythonpath
      - superset_home:/app/superset_home
    depends_on:
      superset-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "celery -A superset.tasks.celery_app:app inspect ping -d celery@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================================================
  # Superset Beat - Celery scheduler for alerts/reports
  # ==========================================================================
  superset-worker-beat:
    image: *superset-image
    container_name: superset_beat
    <<: *superset-env
    command: ["/app/docker/docker-bootstrap.sh", "beat"]
    user: root
    restart: unless-stopped
    volumes:
      - ./docker/pythonpath:/app/pythonpath
      - superset_home:/app/superset_home
    depends_on:
      superset-worker:
        condition: service_healthy
    healthcheck:
      disable: true

volumes:
  redis_data:
  superset_home:
  caddy_data:
  caddy_config:
