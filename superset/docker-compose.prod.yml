# Superset Production Setup
# Uses official Apache Superset image with nginx + certbot SSL
#
# Prerequisites:
#   1. Copy docker/.env.example to docker/.env and configure
#   2. Run ./scripts/init-letsencrypt.sh to obtain SSL certificates
#   3. docker compose -f docker-compose.prod.yml up -d
#
# Architecture:
#   - Nginx handles SSL termination + widget injection
#   - Superset connects to DO Managed PostgreSQL (external)
#   - Redis runs locally for caching/celery
#   - Certbot handles certificate renewal

x-superset-image: &superset-image apache/superset:${SUPERSET_VERSION:-latest}
x-superset-env: &superset-env
  env_file:
    - ./docker/.env

services:
  # ==========================================================================
  # Nginx - SSL termination + widget injection
  # ==========================================================================
  nginx:
    image: nginx:1.27
    container_name: superset_nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - superset
    # Reload nginx when certificates are renewed
    command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"

  # ==========================================================================
  # Certbot - SSL certificate management
  # ==========================================================================
  certbot:
    image: certbot/certbot
    container_name: superset_certbot
    restart: unless-stopped
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    # Renew certificates every 12 hours
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

  # ==========================================================================
  # Redis - Local cache and Celery broker
  # ==========================================================================
  redis:
    image: redis:7
    container_name: superset_redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Superset Init - Database migrations (runs once)
  # ==========================================================================
  superset-init:
    image: *superset-image
    container_name: superset_init
    <<: *superset-env
    command: ["/app/docker/docker-init.sh"]
    user: root
    volumes:
      - ./docker/pythonpath:/app/pythonpath
      - superset_home:/app/superset_home
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      disable: true

  # ==========================================================================
  # Superset App - Main web application (gunicorn)
  # ==========================================================================
  superset:
    image: *superset-image
    container_name: superset_app
    <<: *superset-env
    command: ["/app/docker/docker-bootstrap.sh", "app-gunicorn"]
    user: root
    restart: unless-stopped
    expose:
      - "8088"
    volumes:
      - ./docker/pythonpath:/app/pythonpath
      - superset_home:/app/superset_home
    depends_on:
      superset-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================================================
  # Superset Worker - Celery background tasks
  # ==========================================================================
  superset-worker:
    image: *superset-image
    container_name: superset_worker
    <<: *superset-env
    command: ["/app/docker/docker-bootstrap.sh", "worker"]
    user: root
    restart: unless-stopped
    volumes:
      - ./docker/pythonpath:/app/pythonpath
      - superset_home:/app/superset_home
    depends_on:
      superset-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "celery -A superset.tasks.celery_app:app inspect ping -d celery@$$HOSTNAME"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================================================
  # Superset Beat - Celery scheduler for alerts/reports
  # ==========================================================================
  superset-worker-beat:
    image: *superset-image
    container_name: superset_beat
    <<: *superset-env
    command: ["/app/docker/docker-bootstrap.sh", "beat"]
    user: root
    restart: unless-stopped
    volumes:
      - ./docker/pythonpath:/app/pythonpath
      - superset_home:/app/superset_home
    depends_on:
      superset-worker:
        condition: service_healthy
    healthcheck:
      disable: true

volumes:
  redis_data:
  superset_home:
